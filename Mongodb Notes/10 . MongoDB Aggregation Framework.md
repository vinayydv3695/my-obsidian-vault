

# # **1. What is Aggregation?**

MongoDB Aggregation Framework is a **server-side pipeline** used to:

- Transform documents
    
- Analyze data
    
- Generate reports
    
- Replace complex client-side logic
    

Aggregation equals **SQL GROUP BY + JOIN + FUNCTIONS**, but more flexible.

### **Benefits**

- Runs inside MongoDB server → Fast
    
- Highly composable
    
- Efficient for analytics
    
- Supports complex transformations
    

---

# ---------------------------------------------------------

# # **2. Aggregation Pipeline — Core Stages**

### **Common Pipeline Stages**

|Stage|Purpose|
|---|---|
|**$match**|Filter documents early (like WHERE)|
|**$project**|Transform/reshape/compute fields|
|**$unwind**|Flatten arrays|
|**$group**|Aggregate and summarize|
|**$sort**|Sort output|
|**$limit / $skip**|Pagination|

### **Pipeline Format**

```
db.collection.aggregate([
  { $stage1: { ... } },
  { $stage2: { ... } },
  { $stage3: { ... } }
])
```

---

# ---------------------------------------------------------

# # **3. $match vs find()**

Both use same filter syntax.

### **find()**

Used for retrieving documents.

### **$match**

Used _inside_ a pipeline.

### **Best Practice**

Place `$match` **as early as possible** → pushdown optimization.

### Example

```javascript
db.users.find({ age: { $gt: 25 }, status: "A" })
db.users.aggregate([
  { $match: { age: { $gt: 25 }, status: "A" } }
])
```

---

# ---------------------------------------------------------

# # **4. $sort, $skip, $limit in Aggregation**

Equivalent of:

```
find().sort().skip().limit()
```

### Pagination Pattern

```
$sort → $skip → $limit
```

### Example

```javascript
db.products.aggregate([
  { $match: { category: "laptop" } },
  { $sort: { price: 1, rating: -1 } },
  { $skip: 20 },   // page 3 (size = 10)
  { $limit: 10 }
])
```

---

# ---------------------------------------------------------

# # **5. Field Paths & Nested Fields**

Use **dot notation**:

```
"address.city"
"user.profile.name"
```

### Access array element:

```
$arrayElemAt: ["$tags", 0]
```

### Flatten arrays:

```
$unwind: "$items"
```

---

# ---------------------------------------------------------

# # **6. Basic $match + $project Example**

```javascript
db.employees.aggregate([
  { $match: { dept: "Sales", active: true } },
  {
    $project: {
      _id: 0,
      fullName: { $concat: ["$firstName", " ", "$lastName"] },
      city: "$address.city",
      years: {
        $subtract: [
          { $year: "$$NOW" },
          { $year: "$joinDate" }
        ]
      }
    }
  }
])
```

---

# ---------------------------------------------------------

# # **7. Example: Full Pipeline**

```javascript
db.orders.aggregate([
  { $match: { "shipping.city": "Delhi" } },
  { $sort: { orderDate: -1 } },
  { $skip: 0 },
  { $limit: 5 },
  {
    $project: {
      orderId: "$_id",
      user: "$user.name",
      total: 1,
      date: "$orderDate"
    }
  }
])
```

---

# ---------------------------------------------------------

# # **8. Aggregation Expressions**

### **Boolean Operators**

- `$and`, `$or`, `$not`
    

### **Comparison**

- `$eq`, `$ne`, `$gt`, `$gte`, `$lt`, `$lte`, `$cmp`
    

### **Arithmetic**

- `$add`, `$subtract`, `$multiply`, `$divide`, `$mod`
    

### **String**

- `$concat`, `$substr`, `$toUpper`, `$toLower`, `$regexFind`, `$trim`
    

### **Array**

- `$size`, `$map`, `$filter`, `$slice`, `$arrayElemAt`
    

### **Accumulators**

- `$sum`, `$avg`, `$min`, `$max`, `$mergeObjects`
    

---

# ---------------------------------------------------------

# # **9. Examples of Expressions**

### **Boolean + Comparison**

```javascript
db.users.aggregate([
  {
    $match: {
      $and: [
        { age: { $gte: 18 } },
        { $or: [ { status: "A" }, { status: "B" } ] }
      ]
    }
  },
  {
    $project: {
      name: 1,
      isSenior: { $gte: ["$age", 60] }
    }
  }
])
```

---

# ---------------------------------------------------------

# # **10. Arithmetic + String Expressions**

```javascript
db.items.aggregate([
  {
    $project: {
      item: 1,
      extendedPrice: { $multiply: ["$price", "$qty"] },
      discounted: {
        $subtract: [
          { $multiply: ["$price", "$qty"] },
          { $multiply: ["$price", "$qty", "$discountPct"] }
        ]
      },
      label: {
        $concat: [
          "#",
          "$sku",
          " - ",
          { $toUpper: "$name" }
        ]
      }
    }
  }
])
```

---

# ---------------------------------------------------------

# # **11. $filter — Filter Array Items**

```javascript
db.orders.aggregate([
  {
    $project: {
      orderId: 1,
      heavyItems: {
        $filter: {
          input: "$items",
          as: "it",
          cond: { $gt: ["$$it.qty", 1] }
        }
      }
    }
  }
])
```

---

# ---------------------------------------------------------

# # **12. $arrayElemAt / $slice**

```javascript
db.posts.aggregate([
  {
    $project: {
      firstComment: { $arrayElemAt: ["$comments", 0] },
      top3Tags: { $slice: ["$tags", 3] },
      last2Tags: { $slice: ["$tags", -2] }
    }
  }
])
```

---

# ---------------------------------------------------------

# # **13. Transform Arrays using $map**

```javascript
db.orders.aggregate([
  {
    $project: {
      orderId: 1,
      productNames: {
        $map: {
          input: "$items",
          as: "i",
          in: "$$i.productName"
        }
      },
      totalQty: { $sum: "$items.qty" }
    }
  }
])
```

---

# ---------------------------------------------------------

# # **14. Flatten Arrays with $unwind**

```javascript
db.orders.aggregate([
  { $unwind: "$items" },
  {
    $project: {
      orderId: 1,
      sku: "$items.sku",
      qty: "$items.qty"
    }
  }
])
```

---

# ---------------------------------------------------------

# # **15. $group — Summaries & Statistics**

### Basic Structure

```javascript
{
  $group: {
    _id: <expression>,
    <field>: { <accumulator>: <expression> }
  }
}
```

### Example

```javascript
db.sales.aggregate([
  {
    $group: {
      _id: "$productId",
      totalQty: { $sum: "$qty" },
      avgPrice: { $avg: "$price" },
      maxPrice: { $max: "$price" },
      minPrice: { $min: "$price" }
    }
  }
])
```

---

# ---------------------------------------------------------

# # **16. $merge vs $out**

### **$out**

- Writes pipeline output to a **new collection**
    
- Replaces collection if exists
    

### **$merge**

- Merges into a target collection
    
- Supports upsert / replace / insert
    
- Best for **incremental rollups**
    

### **$merge Example**

```javascript
db.sales.aggregate([
  { $match: { date: { $gte: ISODate("2025-08-01") } } },
  {
    $group: {
      _id: {
        product: "$productId",
        day: {
          $dateToString: { format: "%Y-%m-%d", date: "$date" }
        }
      },
      orders: { $sum: 1 },
      revenue: { $sum: { $multiply: ["$price", "$qty"] } }
    }
  },
  {
    $merge: {
      into: "daily_sales",
      on: ["_id.product", "_id.day"],
      whenMatched: "replace",
      whenNotMatched: "insert"
    }
  }
])
```

---

# ---------------------------------------------------------

# ⭐ **20 MCQs

---

### **1. Which operator filters documents in a pipeline?**

A) $project  
B) $match  
C) $group  
D) $unwind  
**Answer: B**

---

### **2. To reshape fields, you use:**

A) $sort  
B) $project  
C) $skip  
D) $filter  
**Answer: B**

---

### **3. Which stage flattens arrays?**

A) $unwind  
B) $slice  
C) $map  
D) $merge  
**Answer: A**

---

### **4. The correct pagination order is:**

A) $limit → $skip → $sort  
B) $sort → $limit → $skip  
C) $sort → $skip → $limit  
D) $skip → $sort → $limit  
**Answer: C**

---

### **5. $arrayElemAt retrieves:**

A) Last field  
B) A specific array element  
C) Nested document  
D) Only numeric fields  
**Answer: B**

---

### **6. Which operator maps array items one-by-one?**

A) $map  
B) $group  
C) $sort  
D) $unwind  
**Answer: A**

---

### **7. $filter is used to:**

A) Join collections  
B) Remove array items not matching condition  
C) Sort numeric arrays  
D) Aggregate results  
**Answer: B**

---

### **8. Accumulators work with which stage?**

A) $match  
B) $project  
C) $group  
D) $slice  
**Answer: C**

---

### **9. Which of the following is an accumulator?**

A) $map  
B) $sum  
C) $slice  
D) $regexFind  
**Answer: B**

---

### **10. $out does what?**

A) Exports to CSV  
B) Writes pipeline output to a collection  
C) Sorts documents  
D) Filters documents  
**Answer: B**

---

### **11. $merge is preferable for:**

A) Full rebuilds  
B) Incremental rollups  
C) Schema creation  
D) Deletions  
**Answer: B**

---

### **12. To get first 3 tags of an array:**

A) $slice: ["$tags", -3]  
B) $slice: ["$tags", 3]  
C) $arrayElemAt  
D) $filter  
**Answer: B**

---

### **13. find() and $match share:**

A) Syntax rules  
B) Execution speed  
C) Index behavior  
D) None  
**Answer: A**

---

### **14. Which operator performs arithmetic multiplication?**

A) $concat  
B) $multiply  
C) $map  
D) $cmp  
**Answer: B**

---

### **15. To concatenate strings, use:**

A) $regexFind  
B) $concat  
C) $sum  
D) $trim  
**Answer: B**

---

### **16. $unwind on an array with 3 elements produces:**

A) 1 document  
B) 3 documents  
C) 6 documents  
D) No output  
**Answer: B**

---

### **17. $sum inside $project computes:**

A) Aggregation only  
B) Sum of an array field  
C) Median  
D) String length  
**Answer: B**

---

### **18. $group requires:**

A) _id in combination with accumulators  
B) $skip stage  
C) Only strings  
D) Schema validation  
**Answer: A**

---

### **19. To extract all product names inside an array of items, use:**

A) $slice  
B) $map  
C) $cmp  
D) $count  
**Answer: B**

---

### **20. $project can:**

A) Reshape documents  
B) Create new databases  
C) Manage indexes  
D) Delete collections  
**Answer: A**

---

